name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production
      terraform_action:
        description: 'Terraform action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
          - plan
          - apply
          - destroy

jobs:
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    env:
      TF_ENV: ${{ github.event.inputs.environment }}
      
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false
      
      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION || 'us-east-1' }}
      
      - name: ðŸš€ Initialize Terraform
        id: init
        run: |
          echo "### ðŸš€ Initializing Terraform for ${{ env.TF_ENV }} environment" >> $GITHUB_STEP_SUMMARY
          terraform -chdir=infrastructure/ init
          echo "âœ… Terraform initialized successfully!" >> $GITHUB_STEP_SUMMARY
          echo ""
      
      - name: ðŸ“‹ Terraform Plan
        id: plan
        run: |
          echo "### ðŸ“‹ Creating Terraform Plan" >> $GITHUB_STEP_SUMMARY
          terraform -chdir=infrastructure/ plan -no-color -out=tfplan
          echo "âœ… Terraform plan created successfully!" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "#### Plan Output:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform -chdir=infrastructure/ show -no-color tfplan | head -100 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo ""
      
      - name: ðŸ—ï¸ Terraform Apply
        id: apply
        if: github.event.inputs.terraform_action == 'apply'
        run: |
          echo "### ðŸ—ï¸ Applying Terraform Configuration" >> $GITHUB_STEP_SUMMARY
          terraform -chdir=infrastructure/ apply -auto-approve -no-color
          echo "âœ… Infrastructure deployed successfully!" >> $GITHUB_STEP_SUMMARY
          echo ""
      
      - name: ðŸ’¥ Terraform Destroy
        id: destroy
        if: github.event.inputs.terraform_action == 'destroy'
        run: |
          echo "### ðŸ’¥ Destroying Infrastructure" >> $GITHUB_STEP_SUMMARY
          terraform -chdir=infrastructure/ destroy -auto-approve -no-color
          echo "âœ… Infrastructure destroyed successfully!" >> $GITHUB_STEP_SUMMARY
          echo ""
      
      - name: ðŸ“Š Output Infrastructure Details
        id: output
        if: github.event.inputs.terraform_action != 'destroy'
        run: |
          echo "### ðŸ“Š Infrastructure Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get all outputs in JSON format
          terraform -chdir=infrastructure/ output -json > outputs.json
          
          # Parse and display outputs
          echo "#### ðŸ–¥ï¸ EC2 Instance" >> $GITHUB_STEP_SUMMARY
          echo "- **Instance ID:** \`$(cat outputs.json | jq -r '.ec2_instance_id.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Public IP:** \`$(cat outputs.json | jq -r '.ec2_public_ip.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Public DNS:** \`$(cat outputs.json | jq -r '.ec2_public_dns.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ³ ECR Repository" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository URL:** \`$(cat outputs.json | jq -r '.ecr_repository_url.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository Name:** \`$(cat outputs.json | jq -r '.ecr_repository_name.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“¦ S3 Buckets" >> $GITHUB_STEP_SUMMARY
          echo "- **Model Bucket:** \`$(cat outputs.json | jq -r '.model_bucket_name.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Prediction Data Bucket:** \`$(cat outputs.json | jq -r '.pred_data_bucket_name.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸŒ Application Access" >> $GITHUB_STEP_SUMMARY
          echo "- **Application URL:** \`$(cat outputs.json | jq -r '.application_url.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment Complete for \`${{ env.TF_ENV }}\` environment!**" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ’¾ Upload Terraform Outputs
        if: github.event.inputs.terraform_action != 'destroy'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ env.TF_ENV }}
          path: outputs.json
          retention-days: 30
      
      - name: ðŸ’¾ Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ env.TF_ENV }}
          path: infrastructure/tfplan
          retention-days: 30
