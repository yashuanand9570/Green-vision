name: Infrastructure Status

on:
  workflow_dispatch:
    inputs:
      detailed_output:
        description: 'Show detailed resource information'
        required: false
        default: 'true'
        type: boolean

jobs:
  status:
    name: Check Infrastructure Status
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false
      
      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION || 'us-east-1' }}
      
      - name: ðŸš€ Initialize Terraform
        id: init
        run: |
          echo "### ðŸš€ Initializing Terraform" >> $GITHUB_STEP_SUMMARY
          terraform -chdir=infrastructure/ init
          echo "âœ… Terraform initialized successfully!" >> $GITHUB_STEP_SUMMARY
          echo ""
      
      - name: ðŸ“Š Show Terraform State
        id: state
        run: |
          echo "### ðŸ“Š Current Terraform State" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List all resources in state
          echo "#### Resources in State:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform -chdir=infrastructure/ state list 2>&1 || echo "No state found or error accessing state"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ” Get Infrastructure Outputs
        id: outputs
        run: |
          echo "### ðŸ” Infrastructure Connection Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if outputs exist
          if terraform -chdir=infrastructure/ output -json > outputs.json 2>/dev/null; then
            echo "#### ðŸ–¥ï¸ EC2 Instance" >> $GITHUB_STEP_SUMMARY
            echo "- **Instance ID:** \`$(cat outputs.json | jq -r '.ec2_instance_id.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Public IP:** \`$(cat outputs.json | jq -r '.ec2_public_ip.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Public DNS:** \`$(cat outputs.json | jq -r '.ec2_public_dns.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "#### ðŸ³ ECR Repository" >> $GITHUB_STEP_SUMMARY
            echo "- **Repository URL:** \`$(cat outputs.json | jq -r '.ecr_repository_url.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Repository Name:** \`$(cat outputs.json | jq -r '.ecr_repository_name.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "#### ðŸ“¦ S3 Buckets" >> $GITHUB_STEP_SUMMARY
            echo "- **Model Bucket:** \`$(cat outputs.json | jq -r '.model_bucket_name.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Prediction Data Bucket:** \`$(cat outputs.json | jq -r '.pred_data_bucket_name.value // "N/A"')\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "#### ðŸŒ Application Access" >> $GITHUB_STEP_SUMMARY
            APP_URL=$(cat outputs.json | jq -r '.application_url.value // "N/A"')
            echo "- **Application URL:** [\`$APP_URL\`]($APP_URL)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No outputs available. Infrastructure may not be deployed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ”Ž Check AWS Resources
        id: aws_resources
        run: |
          echo "### ðŸ”Ž AWS Resources Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get EC2 instances
          echo "#### EC2 Instances:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=sensor-app" "Name=instance-state-name,Values=running,stopped,pending" \
            --query 'Reservations[*].Instances[*].[InstanceId,State.Name,PublicIpAddress,PrivateIpAddress,InstanceType]' \
            --output table 2>&1 || echo "No EC2 instances found or error accessing EC2"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get S3 buckets related to the project
          echo "#### S3 Buckets:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws s3 ls | grep -E 'sensor-model|sensor-pred-data' || echo "No matching S3 buckets found"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get ECR repositories
          echo "#### ECR Repositories:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws ecr describe-repositories \
            --query 'repositories[*].[repositoryName,repositoryUri,createdAt]' \
            --output table 2>&1 || echo "No ECR repositories found or error accessing ECR"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“ Detailed Resource Information
        id: detailed
        if: github.event.inputs.detailed_output == 'true'
        run: |
          echo "### ðŸ“ Detailed Resource Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show detailed state for each resource
          if [ -f outputs.json ] && [ -s outputs.json ]; then
            INSTANCE_ID=$(cat outputs.json | jq -r '.ec2_instance_id.value // ""')
            
            if [ ! -z "$INSTANCE_ID" ] && [ "$INSTANCE_ID" != "N/A" ]; then
              echo "#### EC2 Instance Details:" >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              aws ec2 describe-instances --instance-ids "$INSTANCE_ID" \
                --query 'Reservations[0].Instances[0]' 2>&1 || echo "Error fetching instance details"
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "#### Security Groups:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=sensor-*" \
            --query 'SecurityGroups[*].[GroupName,GroupId,Description]' \
            --output table 2>&1 || echo "No security groups found"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ’¾ Save Status Report
        run: |
          # Create a detailed status report file
          REPORT_DATE=$(date)
          cat > status-report.txt << EOF
          Infrastructure Status Report
          ============================
          Generated: $REPORT_DATE
          
          Terraform State:
          ----------------
          EOF
          
          terraform -chdir=infrastructure/ state list >> status-report.txt 2>&1 || echo "No state available" >> status-report.txt
          
          echo "" >> status-report.txt
          echo "Outputs:" >> status-report.txt
          echo "--------" >> status-report.txt
          
          if [ -f outputs.json ]; then
            cat outputs.json | jq '.' >> status-report.txt 2>&1 || echo "No outputs available" >> status-report.txt
          else
            echo "No outputs available" >> status-report.txt
          fi
      
      - name: ðŸ’¾ Upload Status Report
        uses: actions/upload-artifact@v3
        with:
          name: infrastructure-status-report
          path: |
            status-report.txt
            outputs.json
          retention-days: 30
      
      - name: âœ… Summary
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status check completed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download the status report artifact for detailed information." >> $GITHUB_STEP_SUMMARY
